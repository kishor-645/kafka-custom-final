{{- if .Values.kafka.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "kafka.fullname" . }}-kafka-controller-config
  labels:
    app.kubernetes.io/name: {{ include "kafka.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: kafka-controller-config
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/part-of: {{ .Chart.Name }}
    helm.sh/chart: {{ include "kafka.chart" . }}
data:
  {{- if .Values.kafka.auth.enabled }}
  # JAAS config will be generated at runtime from mounted secrets
  kafka_server_jaas.conf.template: |
    KafkaServer {
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username="PLACEHOLDER_USERNAME"
        password="PLACEHOLDER_PASSWORD"
        user_PLACEHOLDER_USERNAME="PLACEHOLDER_PASSWORD";
    };
  {{- end }}
  server.properties: |
    # Kafka controller configuration
    process.roles=controller
    node.id=PLACEHOLDER_NODE_ID
    controller.quorum.voters={{ include "kafka.kafka.controllerQuorumVoters" . }}
    listeners=CONTROLLER://:9093
    listener.security.protocol.map=CONTROLLER:PLAINTEXT
    controller.listener.names=CONTROLLER
    log.dirs={{ .Values.kafka.controller.logDir }}
  client.properties: |
    {{- if .Values.kafka.auth.enabled }}
    # Kafka client configuration for SASL authentication
    security.protocol=SASL_PLAINTEXT
    sasl.mechanism=PLAIN
    {{- else }}
    # Kafka client configuration for PLAINTEXT authentication
    security.protocol=PLAINTEXT
    {{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "kafka.fullname" . }}-kafka-broker-config
  labels:
    app.kubernetes.io/name: {{ include "kafka.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: kafka-broker-config
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/part-of: {{ .Chart.Name }}
    helm.sh/chart: {{ include "kafka.chart" . }}
data:
  {{- if .Values.kafka.auth.enabled }}
  # JAAS config will be generated at runtime from mounted secrets
  kafka_server_jaas.conf.template: |
    KafkaServer {
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username="PLACEHOLDER_USERNAME"
        password="PLACEHOLDER_PASSWORD"
        user_PLACEHOLDER_USERNAME="PLACEHOLDER_PASSWORD";
    };
  {{- end }}
  server.properties: |
    # Kafka broker configuration
    process.roles=broker
    node.id=PLACEHOLDER_NODE_ID
    controller.quorum.voters={{ include "kafka.kafka.controllerQuorumVoters" . }}
    listeners={{ .Values.kafka.broker.listeners.internalName }}://:{{ .Values.kafka.broker.listeners.internalPort }},{{ .Values.kafka.broker.listeners.externalName }}://:{{ .Values.kafka.broker.listeners.externalPort }}
    listener.security.protocol.map={{ .Values.kafka.broker.listeners.internalName }}:{{ if .Values.kafka.auth.enabled }}SASL_PLAINTEXT{{ else }}PLAINTEXT{{ end }},{{ .Values.kafka.broker.listeners.externalName }}:{{ if .Values.kafka.auth.enabled }}SASL_PLAINTEXT{{ else }}PLAINTEXT{{ end }},CONTROLLER:PLAINTEXT
    controller.listener.names=CONTROLLER
    advertised.listeners={{- if .Values.kafka.broker.advertisedListeners -}}{{ .Values.kafka.broker.advertisedListeners }}{{- else -}}{{ .Values.kafka.broker.listeners.internalName }}://PLACEHOLDER_POD_NAME.{{ include "kafka.fullname" . }}-kafka-broker.{{ default "default" .Release.Namespace }}.svc.cluster.local:{{ .Values.kafka.broker.listeners.internalPort }},{{ .Values.kafka.broker.listeners.externalName }}://{{ .Values.kafka.broker.externalAdvertisedHost | default .Values.kafka.broker.service.loadBalancerIP }}:{{ .Values.kafka.broker.listeners.externalPort }}{{- end }}
    inter.broker.listener.name={{ .Values.kafka.broker.listeners.internalName }}
    num.partitions=3
    default.replication.factor=1
    offsets.topic.replication.factor=1
    transaction.state.log.min.isr=1
    transaction.state.log.replication.factor=1
    auto.create.topics.enable={{ .Values.kafka.autoCreateTopicsEnable }}
    delete.topic.enable={{ .Values.kafka.deleteTopicEnable }}
    log.dirs={{ .Values.kafka.broker.logDir }}
    {{- if .Values.kafka.auth.enabled }}
    # SASL Authentication configuration
    sasl.enabled.mechanisms=PLAIN
    sasl.mechanism.inter.broker.protocol=PLAIN
    # JAAS configuration file path
    sasl.jaas.config=/opt/kafka/config/kraft/kafka_server_jaas.conf
    {{- end }}
  # Separate config for init container storage formatting
  server-init.properties: |
    process.roles=broker
    node.id=PLACEHOLDER_NODE_ID
    controller.quorum.voters={{ include "kafka.kafka.controllerQuorumVoters" . }}
    listeners={{ .Values.kafka.broker.listeners.internalName }}://:{{ .Values.kafka.broker.listeners.internalPort }},{{ .Values.kafka.broker.listeners.externalName }}://:{{ .Values.kafka.broker.listeners.externalPort }}
    listener.security.protocol.map={{ .Values.kafka.broker.listeners.internalName }}:{{ if .Values.kafka.auth.enabled }}SASL_PLAINTEXT{{ else }}PLAINTEXT{{ end }},{{ .Values.kafka.broker.listeners.externalName }}:{{ if .Values.kafka.auth.enabled }}SASL_PLAINTEXT{{ else }}PLAINTEXT{{ end }},CONTROLLER:PLAINTEXT
    controller.listener.names=CONTROLLER
    inter.broker.listener.name={{ .Values.kafka.broker.listeners.internalName }}
    num.partitions=3
    default.replication.factor=1
    offsets.topic.replication.factor=1
    transaction.state.log.min.isr=1
    transaction.state.log.replication.factor=1
    auto.create.topics.enable={{ .Values.kafka.autoCreateTopicsEnable }}
    delete.topic.enable={{ .Values.kafka.deleteTopicEnable }}
    log.dirs={{ .Values.kafka.broker.logDir }}
    {{- if .Values.kafka.auth.enabled }}
    # SASL Authentication configuration
    sasl.enabled.mechanisms=PLAIN
    sasl.mechanism.inter.broker.protocol=PLAIN
    # JAAS configuration file path
    sasl.jaas.config=/opt/kafka/config/kraft/kafka_server_jaas.conf
    {{- end }}
  client.properties: |
    {{- if .Values.kafka.auth.enabled }}
    # Kafka client configuration for SASL authentication
    security.protocol=SASL_PLAINTEXT
    sasl.mechanism=PLAIN
    {{- else }}
    # Kafka client configuration for PLAINTEXT
    security.protocol=PLAINTEXT
    {{- end }}
  {{- if .Values.kafka.auth.enabled }}
  client_jaas.conf.template: |
    KafkaClient {
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username="PLACEHOLDER_USERNAME"
        password="PLACEHOLDER_PASSWORD";
    };
  {{- end }}
{{- end }}
